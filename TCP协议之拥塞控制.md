## 概念

网络中诸如带宽，路由设备的缓存和处理能力等都是有限的，当网络上某段时间内的负载超过最大设计值时，网络性能就会下降，这种情况我们称为拥塞。

## 拥塞控制 & 流量控制的区别

- 流量控制  
> 流量控制是点对点，端对端的控制，是为了控制发送方的发送速率，确保接收方来得及接收数据  
- 拥塞控制  
> 拥塞控制往往是全局的，防止过多的数据注入到网络中，拥塞控制是为了降低网络整体的拥塞程度  

### TCP 四种拥塞控制算法
- 慢启动
- 拥塞避免
- 快重传
- 快恢复

#### 慢启动
发送方维护一个叫做拥塞窗口cwnd，根据网络状况动态的调整大小；当网络拥塞时，路由器会丢弃报文，当发送方没有按时收到接收方的确认应答时，那么就直到网络发生了拥塞。  

慢启动的”慢“，指的是将 cwnd的值，初始化为1： cwnd=1(这里的1表示的是发送的报文段个数)  
整个过程：  
	1.  开始时发送方的 cwnd = 1， 发送报文段 M1； 如果收到M1 的确认应答，就增大 cwnd=2， 并发送M2， M3报文段  
	2. 注意： 发送方每收到一个确认报文段， cwnd+1(不包括丢失重传的确认), 因此每经过一个 RTT 时间， cwnd 就翻倍，即 cwnd会呈指数增长.
但是， 为了防止拥塞窗口 cwnd 增长过大导致网络拥塞， 会设置一个慢开始门限 ssthresh：  
	1. 当 cwnd < ssthresh， 使用如上的慢启动算法  
	2. 当 cwnd > ssthresh， 停止使用慢开始算法， 转而使用拥塞避免算法  
	3. 当 cwnd = ssthresh， 两者都可以使用  

#### 拥塞避免算法
拥塞避免算法的思路是： 让拥塞窗口 cwnd 缓慢增大， 即没经过一个 RTT，就把发送方的 cwnd+1，而不是加倍，使得 cwnd 线性增大。
此时，假设 ssthresh 为 16， 也就是说，cwnd 超过16就要转换为使用拥塞避免算法， 并且假设到 24 的时候，网络出现拥堵。
接下来有两个指导思想：
	1.  乘法减小：  
   意思就是，当执行拥塞避免算法，cwnd 增长到 24后，我们 将 ssthresh 更新为 ssthresh=24/2=12；然后再重新执行前面的慢启动算法、拥塞避免算法  
	2. 加法增大：  
   指的是， 执行拥塞避免算法之后， cwnd 线性的进行增长，防止很快就又遇到网络拥塞状态。 

#### 快重传
当接收方收到了一个失序的报文，马上报告给发送方，我没收到，赶紧进行重传
1. 接收方应答了 M2的确认报文给发送方；   
2. 此时 M3发送过程中丢失了， 发送方继续在发送M4  
3. 但是接收方发现怎么 M2传完了，就到M4了？ 这M3 没收到啊！ 这个就是收到一个失序的报文。 于是给发送方发送一个重复确认M2（第一步已经回复了M2确认报文）  
4. 这时发送方不管，继续发送M5  
5. 接收方收到M5后， 继续发送重复确认 M2  -- 这个是第二个重复确认M2  
6. 发送方还是不管，继续发送M6  
7. 接收方收到M6后，继续发送重复确认 M2  -- 这个是第三个重复确认 M2  
8. 这里是重点来了！！！  
快重传规定：  发送方只要收到连续三个重复确认，就立即重传对方未收到的M3

#### 快恢复  
快恢复主要也是两个点：
1. 当发送方连续收到三个重复确认，执行乘法减小： ssthresh 减半
2. 由于发送方可能认为网络现在没有拥塞，因此与慢启动不同，把 cwnd的值设置为 ssthresh 减半之后的值，然后执行拥塞避免算法，
	线性增大 cwnd

其实，对于接收方也有一个拥塞窗口叫做 rwnd,  因此发送方窗口的上限 = min(rwnd, cwnd)

